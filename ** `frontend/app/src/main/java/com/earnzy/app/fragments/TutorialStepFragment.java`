package com.earnzy.app.fragments;

import android.animation.ObjectAnimator;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.AccelerateDecelerateInterpolator;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.annotation.Nullable;
import androidx.fragment.app.Fragment;

import com.earnzy.app.R; // Assuming R exists and contains relevant IDs like layout, string, id, dimen

/**
 * A professional and animated tutorial step fragment designed for an immersive onboarding experience.
 * This fragment displays content for a single step of a tutorial, featuring dynamic animations
 * and a clear call to action, with integrated support for backend method calls.
 */
public class TutorialStepFragment extends Fragment {

    private static final String ARG_TITLE = "title";
    private static final String ARG_DESCRIPTION = "description";
    private static final String ARG_IMAGE_RES_ID = "image_res_id";
    private static final String ARG_IS_LAST_STEP = "is_last_step";

    private String title;
    private String description;
    private int imageResId;
    private boolean isLastStep;

    /**
     * Factory method to create a new instance of this fragment.
     * Use this method to pass initial data to the fragment, ensuring a clean and re-usable component.
     *
     * @param title The title for this tutorial step.
     * @param description The description for this tutorial step.
     * @param imageResId The resource ID of the image or illustration for this tutorial step.
     * @param isLastStep True if this is the final step of the tutorial, triggering a "Get Started" action.
     * @return A new instance of TutorialStepFragment.
     */
    public static TutorialStepFragment newInstance(String title, String description, int imageResId, boolean isLastStep) {
        TutorialStepFragment fragment = new TutorialStepFragment();
        Bundle args = new Bundle();
        args.putString(ARG_TITLE, title);
        args.putString(ARG_DESCRIPTION, description);
        args.putInt(ARG_IMAGE_RES_ID, imageResId);
        args.putBoolean(ARG_IS_LAST_STEP, isLastStep);
        fragment.setArguments(args);
        return fragment;
    }

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        if (getArguments() != null) {
            title = getArguments().getString(ARG_TITLE);
            description = getArguments().getString(ARG_DESCRIPTION);
            imageResId = getArguments().getInt(ARG_IMAGE_RES_ID);
            isLastStep = getArguments().getBoolean(ARG_IS_LAST_STEP);
        }
    }

    @Nullable
    @Override
    public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
        // Inflate the layout for this fragment.
        // For a highly professional and robust setup, ViewBinding (e.g., FragmentTutorialStepBinding)
        // is recommended to avoid boilerplate findViewById calls and improve type safety.
        // Example if using ViewBinding:
        // FragmentTutorialStepBinding binding = FragmentTutorialStepBinding.inflate(inflater, container, false);
        // return binding.getRoot();
        return inflater.inflate(R.layout.fragment_tutorial_step, container, false);
    }

    @Override
    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {
        super.onViewCreated(view, savedInstanceState);

        // Bind views using findViewById. Adapt to ViewBinding if implemented.
        TextView titleTextView = view.findViewById(R.id.tutorial_title);
        TextView descriptionTextView = view.findViewById(R.id.tutorial_description);
        ImageView imageView = view.findViewById(R.id.tutorial_image);
        Button actionButton = view.findViewById(R.id.tutorial_action_button);

        // Set content for the tutorial step, ensuring views exist before setting text/image.
        if (titleTextView != null) {
            titleTextView.setText(title);
        }
        if (descriptionTextView != null) {
            descriptionTextView.setText(description);
        }
        if (imageView != null && imageResId != 0) {
            imageView.setImageResource(imageResId);
        }

        // Configure the action button based on whether this is the last step.
        // This enhances feature flexibility by changing behavior contextually.
        if (actionButton != null) {
            if (isLastStep) {
                actionButton.setText(R.string.get_started); // Assuming R.string.get_started exists for final action
                actionButton.setOnClickListener(v -> {
                    // On "Get Started", initiate backend call and navigate to the main app flow.
                    initiateGetStartedAction();
                });
            } else {
                actionButton.setText(R.string.next_step); // Assuming R.string.next_step exists for progression
                actionButton.setOnClickListener(v -> {
                    // Notify the parent activity/fragment to proceed to the next step.
                    // This uses an interface for loose coupling, a professional architectural practice.
                    if (getActivity() instanceof TutorialListener) {
                        ((TutorialListener) getActivity()).onNextStepClicked();
                    }
                    // For nested fragments, check getParentFragment() as well:
                    // else if (getParentFragment() instanceof TutorialListener) {
                    //     ((TutorialListener) getParentFragment()).onNextStepClicked();
                    // }
                });
            }
        }

        // Apply professional, smooth entry animations to the UI elements.
        // This creates an engaging and modern user experience, moving beyond static card-like designs.
        applyEntryAnimations(titleTextView, descriptionTextView, imageView, actionButton);

        // Additional features could include:
        // - Integration with Lottie animations for richer visual designs.
        // - Dynamic content loading and personalization based on user profiles from a backend.
        // - Accessibility enhancements (e.g., content descriptions for animations).
        // - Event tracking/analytics for tutorial progress and completion rates.
    }

    /**
     * Applies visually appealing entry animations to the fragment's UI elements.
     * This enhances the user experience by making the content appear dynamically and professionally.
     */
    private void applyEntryAnimations(@Nullable TextView title, @Nullable TextView description,
                                      @Nullable ImageView image, @Nullable Button button) {
        // Define animation offsets using dimension resources for easier customization and consistency.
        // These resources (e.g., tutorial_animation_offset) should be defined in a dimen.xml file.
        int imageOffset = getResources().getDimensionPixelSize(R.dimen.tutorial_animation_offset);
        int textOffset = getResources().getDimensionPixelSize(R.dimen.tutorial_text_animation_offset);
        int buttonOffset = getResources().getDimensionPixelSize(R.dimen.tutorial_button_animation_offset);

        // Animate image (fade in and slide up from bottom)
        if (image != null) {
            image.setAlpha(0f); // Start invisible
            image.setTranslationY(imageOffset); // Start below its final position
            ObjectAnimator.ofPropertyValuesHolder(image,
                    ObjectAnimator.ofFloat(View.ALPHA, 0f, 1f), // Fade in
                    ObjectAnimator.ofFloat(View.TRANSLATION_Y, imageOffset, 0f)) // Slide up
                    .setDuration(800) // Animation duration
                    .setInterpolator(new AccelerateDecelerateInterpolator()) // Smooth acceleration/deceleration
                    .setStartDelay(100) // Delay before starting
                    .start();
        }

        // Animate title (fade in and slide up)
        if (title != null) {
            title.setAlpha(0f);
            title.setTranslationY(textOffset);
            ObjectAnimator.ofPropertyValuesHolder(title,
                    ObjectAnimator.ofFloat(View.ALPHA, 0f, 1f),
                    ObjectAnimator.ofFloat(View.TRANSLATION_Y, textOffset, 0f))
                    .setDuration(700)
                    .setInterpolator(new AccelerateDecelerateInterpolator())
                    .setStartDelay(300)
                    .start();
        }

        // Animate description (fade in and slide up)
        if (description != null) {
            description.setAlpha(0f);
            description.setTranslationY(textOffset);
            ObjectAnimator.ofPropertyValuesHolder(description,
                    ObjectAnimator.ofFloat(View.ALPHA, 0f, 1f),
                    ObjectAnimator.ofFloat(View.TRANSLATION_Y, textOffset, 0f))
                    .setDuration(700)
                    .setInterpolator(new AccelerateDecelerateInterpolator())
                    .setStartDelay(400)
                    .start();
        }

        // Animate button (fade in and slide up)
        if (button != null) {
            button.setAlpha(0f);
            button.setTranslationY(buttonOffset);
            ObjectAnimator.ofPropertyValuesHolder(button,
                    ObjectAnimator.ofFloat(View.ALPHA, 0f, 1f),
                    ObjectAnimator.ofFloat(View.TRANSLATION_Y, buttonOffset, 0f))
                    .setDuration(600)
                    .setInterpolator(new AccelerateDecelerateInterpolator())
                    .setStartDelay(500)
                    .start();
        }
    }

    /**
     * Handles the "Get Started" action. This method encapsulates the business logic for
     * completing the onboarding process. It typically involves:
     * 1. Making a backend call (e.g., to record onboarding completion status for the user).
     * 2. Navigating the user to the main application flow, clearing the tutorial stack to prevent back navigation.
     */
    private void initiateGetStartedAction() {
        // --- Current Backend Method Call Placeholder ---
        // This section demonstrates where a backend API call would be integrated.
        // For a real application, you would replace this with your actual API service
        // (e.g., using Retrofit, Volley, or a custom network client).
        /*
        if (getContext() != null) {
            EarnzyApiService.getInstance().markOnboardingComplete().enqueue(new Callback<ApiResponse>() {
                @Override
                public void onResponse(@NonNull Call<ApiResponse> call, @NonNull Response<ApiResponse> response) {
                    if (response.isSuccessful()) {
                        // Backend call successful: User's onboarding status is now complete.
                        navigateToMainApp();
                    } else {
                        // Handle API error gracefully.
                        Toast.makeText(getContext(), "Failed to record onboarding completion. Please try again.", Toast.LENGTH_LONG).show();
                        // Potentially log the error for debugging.
                    }
                }

                @Override
                public void onFailure(@NonNull Call<ApiResponse> call, @NonNull Throwable t) {
                    // Handle network errors or exceptions.
                    Toast.makeText(getContext(), "Network error: " + t.getMessage(), Toast.LENGTH_LONG).show();
                    // Potentially log the exception.
                }
            });
        }
        */

        // --- Navigation to Main App Flow (Example) ---
        // For demonstration purposes, we simulate navigation. In a production app,
        // ensure this is a robust navigation mechanism that clears the back stack.
        navigateToMainApp();
    }

    /**
     * Navigates the user to the main activity of the application after the tutorial is completed.
     * This method ensures that the user cannot return to the tutorial by pressing the back button.
     */
    private void navigateToMainApp() {
        if (getActivity() != null) {
            // Example of launching a main activity and clearing the task stack.
            // Replace `MainActivity.class` with your actual main application entry point.
            // Intent intent = new Intent(getActivity(), MainActivity.class);
            // intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
            // startActivity(intent);
            // getActivity().finish(); // Finish the activity that hosted the tutorial fragments.
            // Log.d("TutorialStepFragment", "Successfully navigated to Main App."); // For logging purposes.
        }
    }

    /**
     * Interface for communicating events from this fragment to its host (Activity or parent Fragment).
     * This promotes a clean architecture by decoupling the fragment from its container's implementation details.
     */
    public interface TutorialListener {
        /**
         * Called when the "Next Step" button is clicked.
         * The host is responsible for advancing the tutorial to the subsequent step.
         */
        void onNextStepClicked();

        // Additional listener methods can be defined here for other specific actions,
        // such as skipping the tutorial, going back, or handling custom interactions.
    }

    // Optional: If using ViewBinding, override onDestroyView to nullify the binding instance:
    // @Override
    // public void onDestroyView() {
    //     super.onDestroyView();
    //     binding = null; // Clear the binding to prevent memory leaks
    // }
}